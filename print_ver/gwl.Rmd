---
topic: "water"
title: "Long-Term Trends in Groundwater Levels in B.C."
output: envreportutils.internal::print_ver
header-includes:
  - \usepackage{xcolor,colortbl}
  - \usepackage{longtable, booktabs}
---
<!--
Copyright 2018 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


```{r set-options, echo = FALSE, warning = FALSE, message = FALSE}
# 
# envreportutils.internal::print_ver
knitr::opts_chunk$set(cache = TRUE)
library(dplyr)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(scales)
library(ggmap)
library(bcgroundwater)
library(envreportutils)
library(gridExtra)

base_theme <- theme_get()

load('../tmp/raw_data.RData')
load('../tmp/analysis_data.RData')
load('../tmp/map_data.RData')
load('../tmp/figs.RData')

attr_wells <- results_out[results_out$category != "N/A",]

attr_wells$state <- factor(attr_wells$state,
                           levels = c("Increasing", "Stable",
                                      "Moderate Rate of Decline",
                                      "Large Rate of Decline"),
                           ordered = TRUE)

attr_wells$category <- factor(attr_wells$category, 
                              levels = c("Stable or Increasing", 
                                         "Moderate Rate of Decline",
                                         "Large Rate of Decline"),
                              ordered = TRUE)

state.summary <- table(attr_wells$state)
state.summary <- cbind(n = state.summary, prop = prop.table(state.summary))

theme_set(theme_classic() + 
            theme(text = element_text(colour = "#666666"),
                  axis.line = element_blank(),
                  axis.ticks = element_blank(),
                  panel.grid.major = element_line(colour = "grey85", size = 0.5,
                                                  linetype = 1),
                  panel.grid.minor = element_line(colour = "grey90", size = 0.5,
                                                  linetype = 1),
                  panel.grid.major.x = element_blank(),
                  panel.spacing = unit(0.6, "lines"),
                  plot.title = element_text(vjust = 2),
                  axis.title = element_text(vjust = 0.1),
                  legend.position = "bottom", legend.title = element_blank(),
                  axis.text.x = element_blank(),
                  strip.background = element_blank()))

label.colour <- "#3d3d3d"
colour.scale <- brewer.pal(3,"Blues")

updateDate <- format(Sys.Date(), "%B %Y")
```


Up to 1 million British Columbians are estimated to consume groundwater,
and hundreds of groundwater aquifers provide water for industries,
municipalities, farms, and rural homeowners in British Columbia. B.C.
operates a provincial observation well network&mdash;established in 1961&mdash;to monitor groundwater availability in areas of
high human use.

-   Observation wells are not used for domestic or commercial use, but
instead provide monitoring information on groundwater levels over time.

-   Monitoring groundwater levels allows us to know how much groundwater
is available given human use patterns, aquifer characteristics,
weather and climate patterns^[1](#fn1)^.

-   This indicator presents a statistical analysis of long-term trends
in groundwater levels recorded at `r nrow(attr_wells)` observation wells 
that have been monitored for ten years or more and were active as of 2018.

-   Of the examined wells, `r round(sum(state.summary[c("Stable","Increasing"),"prop"]*100))`% have water levels that are stable
or increasing (with `r state.summary["Increasing","n"]` wells showing 
increasing trends); `r round(state.summary["Moderate Rate of Decline","prop"]*100)`% of wells 
show a moderate rate of decline in water levels (between 3 and 10 cm per year); and `r round(state.summary["Large Rate of Decline","prop"]*100)`% 
of observation wells show a large rate of decline in water levels (more
than 10 cm per year).

Groundwater levels are sensitive to precipitation, aquifer storage
capacity, recharge rate and human withdrawal. Groundwater level trends
presented here indicate long-term changes in water level, but have not
been corrected for changes in precipitation patterns or other factors.
Thus, any significant trends are not necessarily directly attributable
to human use. However, information on long-term trends can be useful for
prompting further research and informing decision-making.

\newpage

## Trends in Groundwater Levels - Provincial Summaries

The charts below summarise the proportions of groundwater observation wells with
groundwater levels in three long-term trend categories: stable or increasing, moderate rate of decline (3 to 10 cm/year), and large rate of decline (more than 10 cm/year). These summaries are also presented
by region and aquifer type.

\vspace{30pt}

```{r pie, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.width = 5, fig.height = 6, fig.align = 'center'}
pie_plot + theme(title = element_text(colour = "black", size = 8, face = "bold"),
                 legend.text = element_text(colour = "black", size = 9))
```

\newpage

```{r region, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
regional_plot + theme(title = element_text(colour = "black",
                                           size = 8, face = "bold"),
                 legend.text = element_text(colour = "black", size = 9))
```


\vspace{20pt}

```{r aquifers, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
aq_plot + theme(title = element_text(colour = "black",
                                     size = 8, face = "bold"),
                 legend.text = element_text(colour = "black", size = 9))
```

\newpage

## Trends in Groundwater Levels - Individual Observation Well Summaries

\vspace{30pt}

**Locations of `r nrow(attr_wells)` Groundwater Observation Wells Included in the Analysis**

```{r overview_map, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results = 'asis', fig.height = 6}
ggmap(ggMapBC, extent = "device") + 
  coord_map(xlim = c(-139, -114), ylim = c(47.8,60)) + 
  geom_point(data = attr_wells, aes(x = Long, y = Lat, fill = category), 
             shape = 21, size = 2.5, colour = colour.scale[3]) + 
  scale_fill_manual(values = colour.scale) + 
  theme(legend.position = "bottom", legend.title = element_blank(),
        legend.text = element_text(colour = "black", size = 9))
```
\newpage

**Groundwater Level Trend Results for Observation Wells Included in the Analysis**

\definecolor{stable}{HTML}{`r substr(colour.scale[1], 2, 7)`}
\definecolor{moderate}{HTML}{`r substr(colour.scale[2], 2, 7)`}
\definecolor{large}{HTML}{`r substr(colour.scale[3], 2, 7)`}

\small
```{r table, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results = 'asis'}
library(xtable)
library(lubridate)

out.table <- attr_wells[,c("REGION_NAME", "Well_Num", "start_date", "last_date",  
                           "trend_line_slope", "sig", "state")]

out.table$date_range <- paste(year(out.table$start_date), "-", 
                              year(out.table$last_date))

out.table <- arrange(out.table, REGION_NAME, as.numeric(Well_Num))

out.table$trend_line_slope <- -out.table$trend_line_slope

out.table <- out.table %>%
  select(REGION_NAME, Well_Num, date_range, trend_line_slope, sig, state)

names(out.table) <- c("Region", "Well", "Date Range", 
                      "Slope (m/yr)", "Sig", "State")

out.table$Sig <- ifelse(out.table$Sig < 0.05, "p < 0.05", 
                        round(out.table$Sig,3))

x.table <- xtable(out.table, digits = 2)

# Set the slope column as fixed width
align(x.table) <- c('l', rep('l', 3), 'p{0.5in}', rep('l', 2))

# Define colours of rows based on state
HL_col <- ifelse(out.table$State == "Large Rate of Decline", "\\rowcolor{large}", 
                 ifelse(out.table$State == "Moderate Rate of Decline", 
                        "\\rowcolor{moderate}", "\\rowcolor{stable}"))
HL_rows <- seq(0, length(HL_col)-1, by = 1)
HL_col[1] <- paste0("\\hline ", HL_col[1]) # Hack to get a hline below headings

print(x.table, tabular.environment = 'longtable', floating = FALSE,
      hline.after = c(-1,nrow(x.table)), 
      add.to.row = list(pos = list(as.list(HL_rows))[[1]], 
                        command = HL_col), 
      booktabs = TRUE, 
      include.rownames = FALSE, sanitize.colnames.function = NULL, 
      sanitize.text.function = NULL, comment = FALSE)
```

\newpage

## References and Other Useful Links

-   [Provincial Observation Well Network](https://www2.gov.bc.ca/gov/content?id=B03D0994BB5C4F98B6F7D4FD8610C836)

-   [B.C. Groundwater Wells & Aquifers](https://apps.nrs.gov.bc.ca/gwells/)

-   [B.C. Water Data & Tools](https://www2.gov.bc.ca/gov/content?id=A9E4D7847FBC42CEB3A9E8ABAC364BD6)


- ^1^[Gurdak, J.J., R.T. Hanson, and T.R. Green. 2009. Effects of Climate Variability and Change on Groundwater Resources of the United States. United States Geological Survey. Fact Sheet 2009â€“3074. (PDF)](https://pubs.usgs.gov/fs/2009/3074/pdf/FS09-3074.pdf)


## Data

\*By accessing these datasets, you agree to the licence associated with
each file, as indicated in parentheses below.

-   [Indicator Summary Data: Long-term Trends in B.C. Groundwater Levels](https://catalogue.data.gov.bc.ca/dataset/a74f1b97-17f7-499b-84e7-6455e169e425)
(Licence: [Open Government Licence - British Columbia](http://www2.gov.bc.ca/gov/content?id=A519A56BC2BF44E4A008B33FCF527F61))


Published and Available On-Line at Environmental Reporting BC (`r updateDate`): <http://www.env.gov.bc.ca/soe/indicators/water/groundwater-levels.html>


## Appendix: Detailed Maps & Graphs for Individual Groundwater Observation Wells

Three plots were created for each examined groundwater observation well, including a map of the wellâ€™s location (upper left).

The graph to the right of the map shows monthly groundwater levels
relative to the annual average. This illustrates the seasonal nature of
water levels recorded in that well&mdash;many wells will have higher than
average water levels in the spring, and lower than average levels in the
late summer and fall. The shaded blue area shows the range of variation
within which 90% of water level observations in that month fall.

The bottom plot&mdash;called a "hydrograph"&mdash;on each page shows the monthly
groundwater levels for the history of the well, with the orange line
representing the calculated trend in annual average groundwater levels.
The slope and significance of the trend are given below the title. Red
dots show missing values which were interpolated (see Methods).

\newpage

```{r well_plots, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results = 'asis', fig.height = 7.5}
knitr_latex_char <- function(x) {
  y <- gsub("\\\\", "\\\\textbackslash{}", x) # backslash has to be first!
  y <- gsub("([#$%&_])", "\\\\\\1", y) # Doesn't deal with { or } because of function{}
  y <- gsub("\\^", "\\\\textasciicircum{}", y)
  y <- gsub("~", "\\\\textasciitilde{}", y)
  return(y)
}

theme_set(base_theme)

for (reg in sort(unique(attr_wells$REGION_NAME))) {
  cat(paste0('\\subsection{',reg,'}'))
  regdata <- filter(attr_wells, REGION_NAME == reg)
  
  for (well in regdata$Well_Num) {
    if (is.na(well)) next

    well.attr <- filter(regdata, Well_Num == well)
    wellLong <- well.attr$Long
    wellLat <- well.attr$Lat
    wellColour <- with(well.attr, ifelse(category == "Large Rate of Decline",
                                         colour.scale[3],
                                         ifelse(category=="Stable or Increasing",
                                                colour.scale[1],
                                                colour.scale[2])))
    wellname <- well.attr$Well_Name
    
    cat(paste0('\\subsubsection*{', 
               knitr_latex_char(wellname),
               '}'))
    
    cat(paste0("This provincial groundwater observation well is drilled into a ",
               well.attr$AQUIFER_TYPE, 
               " aquifer to a depth of ", well.attr$wellDepth_m, 
               " metres. The well has a monitoring period of record from ", 
               format(well.attr$start_date, format = "%B %d %Y"), 
               " to ", format(well.attr$last_date, format = "%B %d %Y"), ". \\newline",
               "\\newline"))
    
    plotdata <- monthlywells_ts[monthlywells_ts$Well_Num == well,]

    mapplot <- plotPointWithInset(long = wellLong, lat = wellLat,
                                  pointColour = wellColour,
                                  bigMap = wellMaps[well][[1]],
                                  overviewMap = ggMapBC,
                                  overviewExtent = BCextent,
                                  opts = theme(plot.margin = unit(c(0.5,0.5,0.5,0.01),
                                                                  "cm")))
    
    areaplot <- gwlAreaPlot(data = plotdata, trend = well.attr$trend_line_slope,
                            intercept = well.attr$trend_line_int,
                            state = well.attr$state, sig = well.attr$sig,
                            showInterpolated = TRUE, save = FALSE,
                            mkperiod = "monthly",
                            opts = theme(plot.margin = unit(c(0.5,0.5,0.5,0.01),
                                                            "cm")))
    
    monthplot <- gwlMonthlyPlot(dataframe = plotdata, splines = TRUE, save = FALSE,
                                opts = theme(plot.margin = unit(c(0.5,0.01,0.5,0.01),
                                                                "cm")))
    
    grid.arrange(mapplot + theme(text = element_text(size = 10)),
                 monthplot + theme(text = element_text(size = 10),
                                   title = element_text(colour = "black",
                                   size = 8, face = "bold"),
                                   axis.title.y = element_text(hjust = 0.3)),
                 areaplot + theme(text = element_text(size = 10),
                                  title = element_text(colour = "black",
                                   size = 8, face = "bold")),
                 layout_matrix = matrix(c(1,2,3,3), nrow = 2, byrow = TRUE))
    
    cat('\\newpage ')
  }
  
}
```
